---
output:
  word_document: default
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

#Import dataset

```{r, echo=FALSE}
library(caret)
library(GGally)
library(cluster)
library(FactoMineR)
library(plyr)
library(psych)

load("./Data/df_preprocessed_IBM_Employees.Rdata") 
names(df) 
df0<-df
```

# 0 - Get relevant columns

```{r}
catdes(df, num.var=2, proba=0.01)

# Relevant p-values
df<-subset(df, select = c(OverTime,JobLevel,StockOptionLevel, MaritalStatus, JobRole, JobInvolvement,EnvironmentSatisfaction, JobSatisfaction,SalaryHikePerYear,TotalWorkingYears,YearsInCurrentRole,MonthlyIncome,Age,YearsWithCurrManager,AverageYearsCompany,YearsAtCompany))

#JobInvolvement,EnvironmentSatisfaction, JobSatisfaction, MaritalStatus,StockOptionLevel
#df<-subset(df, select = c(OverTime,JobLevel, JobRole,SalaryHikePerYear,TotalWorkingYears,YearsInCurrentRole,MonthlyIncome,Age,YearsWithCurrManager,AverageYearsCompany,YearsAtCompany))

```

# 1 - Transform numerical variables (normalize and scale)

```{r, echo=FALSE}

dcon<-df[!sapply(df, is.factor)]

df_trans <- dcon

# Loop`histograms for numeric variables`
lapply(X=colnames(dcon), FUN=function(s){ 
    hist(dcon[, s], main=paste("Histogram of", s)) 
})

hist(log(dcon$SalaryHikePerYear))
df_trans$SalaryHikePerYear <- log(dcon$SalaryHikePerYear+1)

hist(log(dcon$TotalWorkingYears))
df_trans$TotalWorkingYears <- log(dcon$TotalWorkingYears+0.5)

hist(log(dcon$YearsInCurrentRole))
df_trans$YearsInCurrentRole <- log(dcon$YearsInCurrentRole+0.5)

hist(log(dcon$MonthlyIncome))
df_trans$MonthlyIncome <- log(dcon$MonthlyIncome)

hist(scale(dcon$Age))
df_trans$Age <- scale(dcon$Age)[,1]

hist(log(dcon$YearsWithCurrManager))
df_trans$YearsWithCurrManager <- log(dcon$YearsWithCurrManager+0.5)

hist(log(dcon$AverageYearsCompany))
df_trans$AverageYearsCompany <- log(dcon$AverageYearsCompany+0.5)

df_norm<-df_trans
colnames(df_norm)

range01 <- function(x){ (x-min(x))/(max(x)-min(x)) }

for (colname in colnames(dcon)) {
  df_norm[,colname]<-range01(df_norm[,colname])
}

boxplot(df_norm[,c(1:8)])

```

# 2 - Add categorical variables to final Dataframe

```{r, echo=FALSE}

dcat<-df[sapply(df, is.factor)]

for (colname in colnames(dcat)) { df_norm[,colname]<- dcat[,colname] }

colnames(df_norm)
boxplot(df_norm) 

```

# 3 - Clustering

```{r, echo=FALSE}

#dissimilarity matrix
dissimMatrix <- daisy(df_norm, metric = "gower", stand=TRUE)
distMatrix<-dissimMatrix^2
summary(df_norm)
h1<-hclust(distMatrix,method="ward.D")
options(max.print=2000)
options(scipen=999)
h1$height
plot(h1) 
# For first subset
rect.hclust(h1, h=8.97556177712,border="green") # 6 clusters
rect.hclust(h1, h=17.29880121544,border="red") # 3 clusters
rect.hclust(h1, h=21.59377395634,border="blue") # 3 clusters

# For second subset
#rect.hclust(h1, h=11.74583336365,border="green") # 5 clusters
#rect.hclust(h1, h=20.86606866385,border="red") # 4 clusters
#rect.hclust(h1, h=25.64470082455,border="blue") # 2 clusters


c1<-cutree(h1,2)
df$cluster<-c1

cdg <- aggregate(as.data.frame(df_norm),list(c1),mean) 
cdg

df_norm$Attrition<-df0$Attrition

c2<-cutree(h1,2)
df_norm$clust<-as.factor(c2)
table(df_norm$Attrition,df_norm$clust)
#plot results
ggpairs(df_norm, columns = c(1:4), aes(color = clust, alpha = 0.5),progress = FALSE)
ggpairs(df_norm, columns = c(5:8), aes(color = clust, alpha = 0.5),progress = FALSE)
ggpairs(df_norm, columns = c(9:13), aes(color = clust, alpha = 0.5),progress = FALSE)

c2<-cutree(h1,3)
df_norm$clust<-as.factor(c2)
table(df_norm$Attrition,df_norm$clust)
#plot results
ggpairs(df_norm, columns = c(1:4), aes(color = clust, alpha = 0.5),progress = FALSE)
ggpairs(df_norm, columns = c(5:8), aes(color = clust, alpha = 0.5),progress = FALSE)
ggpairs(df_norm, columns = c(9:13), aes(color = clust, alpha = 0.5),progress = FALSE)

c2<-cutree(h1,6)
df_norm$clust<-as.factor(c2)
table(df_norm$Attrition,df_norm$clust)
#plot results
ggpairs(df_norm, columns = c(1:4), aes(color = clust, alpha = 0.5),progress = FALSE)
ggpairs(df_norm, columns = c(5:8), aes(color = clust, alpha = 0.5),progress = FALSE)
ggpairs(df_norm, columns = c(9:13), aes(color = clust, alpha = 0.5),progress = FALSE)

```
